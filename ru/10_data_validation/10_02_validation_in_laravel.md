# Валидация данных в Laravel

## Что такое валидация и почему она важна?

**Валидация данных** — это процесс проверки входных данных на соответствие определенным правилам перед их обработкой. В Laravel валидация встроена в фреймворк и обеспечивает удобные и гибкие инструменты для проверки данных. Основная задача валидации в Laravel — предотвратить работу приложения с некорректными или потенциально вредоносными данными.

Laravel предлагает несколько способов реализации валидации:

1. Валидация внутри контроллеров.
2. Использование объектов `Form Request`.
3. Валидация вручную с помощью фасада `Validator`.

Каждый подход имеет свои преимущества и подходит для различных сценариев. **Например**, небольшие проверки удобно делать прямо в контроллере, а более сложные — выносить в отдельные классы.

## Валидация в Laravel

### Основные правила валидации

Laravel предоставляет богатый набор встроенных правил, таких как:

- `required` — поле обязательно.
- `email` — данные должны быть корректным адресом электронной почты.
- `max:value` — ограничение на максимальное количество символов.
- `min:value` — ограничение на минимальное количество символов.
- `unique:table,column` — проверка на уникальность в базе данных.

Полный список правил доступен в [документации Laravel](https://laravel.com/docs/11.x/validation#available-validation-rules).

Пример использования встроенных правил:

```php
$validatedData = $request->validate([
    'title' => 'required|min:3',
    'email' => 'required|email',
    'password' => 'required|min:6',
]);
```

Этот код проверяет, что поле name является строкой и не превышает 255 символов, поле email содержит уникальный адрес электронной почты, а пароль состоит как минимум из 8 символов и совпадает с подтверждением.

### Сообщения об ошибках

Laravel автоматически создает сообщения об ошибках для стандартных правил, но вы можете настроить их вручную в файле перевода `resources/lang/{locale}/validation.php` или передать их напрямую:

```php
$validatedData = $request->validate([
    'title' => 'required|min:3',
    'email' => 'required|email',
    'password' => 'required|min:6',
], [
    'title.required' => 'Поле "Название" обязательно для заполнения',
    'email.email' => 'Поле "Email" должно быть корректным адресом электронной почты',
]);
```

### Валидация в контроллерах

Простейший способ валидации — использовать метод `validate` в контроллере:

```php
public function store(Request $request)
{
    $validatedData = $request->validate([
        'title' => 'required|min:3',
        'email' => 'required|email',
        'password' => 'required|min:6',
    ]);

    // Данные прошли валидацию
}
```

### Как работает метод `validate`?

Метод `validate` принимает два аргумента: массив правил валидации и массив сообщений об ошибках. Если данные не проходят валидацию, Laravel автоматически перенаправляет пользователя **обратно на предыдущую страницу с ошибками валидации**.

## Создание собственных классов Request

Классы `Form Request` — это специализированные классы для обработки и валидации данных. Они позволяют вынести логику проверки из контроллеров, что улучшает читаемость кода и упрощает поддержку.

Каждый класс `Form Request` является расширением базового класса `Illuminate\Foundation\Http\FormRequest`. В этих классах вы определяете правила валидации и права доступа для конкретного запроса.

### Создание собственного класса Request

Для создания нового класса `Form Request` используйте команду Artisan:

```bash
php artisan make:request CreateTaskRequest
```

После выполнения команды будет создан новый класс `CreateTaskRequest` в каталоге `app/Http/Requests`. В этом классе вы можете определить правила валидации и сообщения об ошибках:

```php
<?php

namespace App\Http\Requests;

use Illuminate\Foundation\Http\FormRequest;

class CreateTaskRequest extends FormRequest
{
    public function authorize()
    {
        return true;
    }

    public function rules()
    {
        return [
            'title' => 'required|min:3',
            'email' => 'required|email',
            'password' => 'required|min:6',
        ];
    }

    public function messages()
    {
        return [
            'title.required' => 'Поле "Название" обязательно для заполнения',
            'email.email' => 'Поле "Email" должно быть корректным адресом электронной почты',
        ];
    }
}
```

### Использование класса Request в контроллере

Для использования класса `Form Request` в контроллере замените объект `Request` на ваш класс:

```php
public function store(CreateTaskRequest $request)
{
    $validatedData = $request->validated();
}
```

Метод `validated()` возвращает все проверенные данные, что исключает необходимость дополнительной проверки.

## Отображение ошибок в Blade

Laravel автоматически возвращает сообщения об ошибках валидации при использовании метода `validate()` или объектов `Form Request`. Эти ошибки можно легко отобразить в шаблонах Blade.

Laravel предоставляет глобальную переменную `$errors`, которая доступна в шаблонах Blade и содержит все сообщения об ошибках.

```blade
@if ($errors->any())
    <div class="alert alert-danger">
        <ul>
            @foreach ($errors->all() as $error)
                <li>{{ $error }}</li>
            @endforeach
        </ul>
    </div>
@endif
```

Этот код отобразит все сообщения об ошибках в списке.

### Вывод ошибки для конкретного поля

Вы можете проверить наличие ошибки для конкретного поля и вывести соответствующее сообщение:

```blade
<div>
    <label for="name">Name</label>
    <input type="text" name="name" id="name" value="{{ old('name') }}">
    @error('name')
        <div class="text-danger">{{ $message }}</div>
    @enderror
</div>
```

Функция `@error` проверяет, есть ли ошибка для указанного поля, и выводит сообщение.

Для удобства пользователя Laravel автоматически сохраняет старые данные при редиректе после ошибки валидации. Вы можете использовать функцию `old()` для восстановления значений:

```blade
<input type="text" name="email" value="{{ old('email') }}">
```

## Валидация связанных данных (ORM)

Часто требуется проверить не только отдельные поля, но и связанные данные, например, проверить, что значение `category_id` существует в базе данных. Для этого можно использовать правило `exists`:

Общий синтаксис правила `exists`: `exists:table,column`. 

- `table` — имя таблицы в базе данных.
- `column` — имя столбца, в котором нужно проверить наличие значения.


```php
public function rules()
{
    return [
        'category_id' => 'required|exists:categories,id',
    ];
}
```

Это правило проверяет, что значение `category_id` существует в таблице `categories` в столбце `id`.

Когда вы используете правило `exists`, Laravel выполняет SQL-запрос к базе данных, чтобы проверить наличие записи. Если значение не найдено, запрос отклоняется, и пользователь получает сообщение об ошибке.

```sql
SELECT COUNT(*) FROM categories WHERE id = :value;
```

Если запрос возвращает **0 записей**, валидация не проходит.

### `unique`

Правило `unique` проверяет, что значение поля уникально в таблице. Например, чтобы проверить уникальность email:

Общий синтаксис правила `unique`: `unique:table,column,except,idColumn`.

- `table` — имя таблицы в базе данных.
- `column` — имя столбца, который должен быть уникальным.
- `except` — исключает текущую запись из проверки.
- `idColumn` — имя столбца с идентификатором текущей записи.

```php
public function rules()
{
    return [
        'email' => 'required|email|unique:users,email',
    ];
}
```


## Заключение

Валидация данных является неотъемлемой частью разработки безопасных и стабильных приложений. Laravel предоставляет мощный и гибкий инструментарий для проверки данных, который легко адаптируется под различные задачи. Использование встроенных правил, таких как `required`, `unique`, `exists` и многие другие, позволяет разработчику сосредоточиться на бизнес-логике приложения, не теряя времени на реализацию сложных проверок вручную.

Выделение логики валидации в отдельные классы Form Request способствует улучшению структуры кода, упрощает его сопровождение и повторное использование. При этом Laravel делает процесс валидации максимально прозрачным и удобным для пользователя, предоставляя встроенные механизмы для отображения ошибок в шаблонах Blade.

Отдельное внимание стоит уделить проверке связанных данных, особенно при работе с ORM. Благодаря поддержке вложенной валидации и правил, таких как exists, разработчик может быть уверен в корректности данных даже в сложных структурах.

Валидация в Laravel — это не только про безопасность, но и про удобство. Она помогает создать более дружественный пользовательский опыт, минимизируя возможность ошибок при вводе данных и давая пользователям понятные сообщения в случае их возникновения.

Используйте возможности Laravel для валидации данных, чтобы ваши приложения были надежными, защищенными и простыми в использовании как для вас, так и для ваших пользователей.
# Миграции в Laravel [^1]

Одним из мощнейших инструментов для работы с базой данных являются миграции.

## Что такое миграции?

**Миграции** — это инструмент, который позволяет управлять структурой базы данных с помощью кода, как если бы вы использовали систему контроля версий для базы данных [^2].

Миграции обеспечивают возможность вносить изменения в структуру базы данных (например, добавлять, изменять или удалять таблицы и столбцы), сохраняя при этом данные. Это особенно полезно в командной работе: вместо того чтобы вручную сообщать коллегам, какие изменения нужно внести в базу данных, вы просто создаёте миграцию, и каждый разработчик может применить её автоматически.

## Создание миграции

Давайте попробуем создать миграцию. Для этого воспользуемся командой `make:migration` и укажем имя миграции.

> [!NOTE] > **Имя миграции** должно отображать изменения, которые вы вносите в базу данных. Например, если вы добавляете таблицу `users`, то имя миграции может быть `create_users_table`, а если вы добавляете столбец `email` в таблицу `users`, то имя миграции может быть `add_email_to_users_table`.

Создадим миграцию для добавления таблицы `posts`.

```bash
php artisan make:migration create_posts_table
```

Laravel попытается угадать тип миграции на основе имени. В данном случае Laravel предполагает, что это будет миграция для создания таблицы.

Миграция будет создана в директории `database/migrations`. Откройте файл миграции и посмотрите, что в нём содержится.

## Структура миграции

Миграция в Laravel содержат два метода: `up` и `down`.

- Метод `up` используется для описания изменений, которые должны быть выполнены при применении миграции.
- Метод `down` содержит код для отката этих изменений, если потребуется отменить миграцию.

**Пример миграции**:

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('posts', function (Blueprint $table) {
            $table->id();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('posts');
    }
};
```

Как видно из примера, вместо написания SQL-запросов для создания таблицы мы используем методы фасада `Schema`. Это упрощает код и делает его более читаемым.

Кроме того, миграции позволяют абстрагироваться от конкретной СУБД. Это значит, что вы можете легко переключаться между различными базами данных (например, использовать SQLite на стадии разработки и MySQL в продакшене) без необходимости менять код миграции — достаточно изменить настройки подключения к базе данных в файле `.env`.

## Применение миграций

Для управления миграциями в Laravel используются следующие команды:

1. Запуск всех непроведённых миграций:

   ```bash
   php artisan migrate
   ```

2. Откат последней миграции:

   ```bash
   php artisan migrate:rollback
   ```

3. Откат всех миграций:

   ```bash
   php artisan migrate:reset
   ```

4. Откат и повторное применение всех миграций:

   ```bash
   php artisan migrate:refresh

   // равносильно
   php artisan migrate:reset
   php artisan migrate
   ```

5. Удаление всех таблиц и повторное применение всех миграций:

   ```bash
   php artisan migrate:fresh
   ```

6. Откат миграций на несколько шагов:

   ```bash
   php artisan migrate:rollback --step=3
   ```

> [!NOTE]
> Это не полный список команд для работы с миграциями. Для получения дополнительной информации обратитесь к [официальной документации Laravel](https://laravel.com/docs/migrations).

## Таблицы

### Создание таблиц

Как видно из примера выше, создание таблиц в Laravel с помощью миграций — это простой и удобный процесс.

Для создания новой таблицы используется метод `Schema::create()`. Первым аргументом передаётся **имя таблицы**, а вторым — **функция**, в которой **описываются столбцы таблицы**.

```php
Schema::create('posts', function (Blueprint $table) {
    $table->id();
    $table->string('title');
    $table->text('content');
    $table->timestamps();
});
```

### Изменение таблиц

Для изменения существующей таблицы используется метод `Schema::table()`. Например, чтобы добавить новый столбец в таблицу, можно использовать этот метод вместо `Schema::create()`.

```php
Schema::table('posts', function (Blueprint $table) {
    $table->string('slug');
});
```

В данном случае таблица `posts` уже существует, и миграция добавляет в неё новый столбец `slug`. Таким образом, у вас будут две миграции: одна для создания таблицы `posts`, а другая — для добавления столбца `slug`.

### Удаление таблиц

Для удаления таблицы используется метод `Schema::dropIfExists()`. Обычно это делается в методе `down` миграции.

```php
// Удаление таблицы
Schema::drop('posts');

// Удаление таблицы, если она существует
// Более безопасный способ
Schema::dropIfExists('posts');
```

### Переименование таблиц

Для переименования таблицы в Laravel используется метод `Schema::rename()`.

```php
Schema::rename('old_table', 'new_table');
```

## Столбцы

После того, как мы создали миграцию, нам необходимо определить структуру таблицы. Мы уже видели примеры создания столбцов в таблице, но давайте рассмотрим более подробно, какие типы столбцов можно использовать.

### Типы столбцов

В Laravel существует множество типов столбцов, которые вы можете использовать при создании таблицы. Полный список типов столбцов можно найти в [официальной документации Laravel](https://laravel.com/docs/migrations#columns).

Рассмотрим самые распространённые типы столбцов.

#### Тип `id`

Тип `id` используется для создания первичного ключа таблицы. По умолчанию Laravel использует тип `bigIncrements`, который создаёт столбец `id` с типом `BIGINT` и автоинкрементом.

```php
$table->id();
```

#### Тип `string`

Тип `string` используется для создания столбца с типом `VARCHAR`.

```php
$table->string('name');
// указание длины
$table->string('name', 100);
```

#### Тип `text`

Тип `text` используется для создания столбца с типом `TEXT`.

```php
$table->text('description');
```

#### Тип `integer`

Тип `integer` используется для создания столбца с типом `INT`.

```php
$table->integer('age');
```

Существует также типы `bigInteger`, `mediumInteger`, `smallInteger` и `tinyInteger` для создания столбцов с другими типами целых чисел (`BIGINT`, `MEDIUMINT`, `SMALLINT`, `TINYINT`).

#### Тип `float`

Тип `float` используется для создания столбца с типом `FLOAT`.

```php
$table->float('price');
// указание точности и масштаба
// (8 цифр в общем, 2 цифры после запятой)
$table->float('price', 8, 2);
```

#### Тип `date` и `dateTime`

Типы `date` и `dateTime` используются для создания столбцов с типами `DATE` и `DATETIME`.

```php
$table->date('birth_date');
$table->dateTime('created_at');
```

#### Тип `boolean`

Тип `boolean` используется для создания столбца с типом `BOOLEAN`.

```php
$table->boolean('is_active');
```

#### Тип `timestamps`

Тип `timestamps` используется для создания двух столбцов: `created_at` и `updated_at`.

При создании данных столбцов Laravel автоматически обновляет их при создании и обновлении записей.

```php
$table->timestamps();
```

Полная миграция может выглядеть следующим образом:

### Модификаторы столбцов

В Laravel, помимо типов столбцов, существуют **модификаторы**, которые позволяют более гибко настраивать столбцы, аналогично SQL.

#### Модификатор `nullable`

Модификатор `nullable` указывает, что столбец может содержать значение `NULL`.

```php
$table->string('email')->nullable();
```

#### Модификатор `default`

Модификатор `default` задаёт значение по умолчанию для столбца.

```php
$table->string('role')->default('user');
```

#### Модификатор `unsigned`

Модификатор `unsigned` используется для целочисленных столбцов и запрещает хранение отрицательных значений.

```php
$table->integer('age')->unsigned();
```

#### Модификатор `unique`

Модификатор `unique` делает значения в столбце уникальными, исключая дублирование.

```php
$table->string('email')->unique();
```

#### Модификатор `after`

Модификатор `after` позволяет задать расположение нового столбца относительно уже существующих. Обычно используется при изменении таблицы, так как при создании новой таблицы этот модификатор не имеет смысла.

```php
$table->string('name')->after('id');
```

#### Модификатор `comment`

Модификатор `comment` позволяет добавить комментарий к столбцу.

```php
$table->string('name')->comment('Имя пользователя');
```

Модификаторы можно комбинировать, чтобы настроить столбцы под нужные требования.

> [!NOTE]  
> Подробнее о типах и модификаторах столбцов вы можете узнать в [официальной документации Laravel](https://laravel.com/docs/migrations#column-modifiers).

### Изменение столбцов

Для изменения существующих столбцов в Laravel используется метод `change()`.

```php
// В таблице 'posts' уже существует столбец 'title'.
// Мы хотим изменить его тип на 'text'.
// Если он был nullable, нужно явно указать это.
Schema::table('posts', function (Blueprint $table) {
    $table->text('title')->nullable()->change();
});
```

При изменении столбца его параметры обновляются. Будьте внимательны, особенно при работе с таблицами, в которых уже есть данные.

### Удаление столбцов

Для удаления столбца из таблицы используется метод `dropColumn()`.

```php
Schema::table('posts', function (Blueprint $table) {
    $table->dropColumn('title');
});
```

### Переименование столбцов

Для переименования столбца в Laravel используется метод `renameColumn()`.

```php
Schema::table('posts', function (Blueprint $table) {
    $table->renameColumn('old_title', 'new_title');
});
```

## Пример миграции

Давайте рассмотрим пример миграции, в которой создаётся таблица `posts` с несколькими столбцами.

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('posts', function (Blueprint $table) {
            $table->id();
            $table->string('title', 200);
            $table->text('content')->nullable();
            $table->string('slug')->unique()->comment('post slug');
            $table->boolean('published')->default(false);
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('posts');
    }
};
```

## Заключение

**Миграции** — это мощный инструмент для управления структурой базы данных в Laravel.

Они позволяют вам создавать, изменять и удалять таблицы и столбцы, делая процесс разработки более удобным и безопасным.

Используйте миграции для управления структурой базы данных в ваших проектах и убедитесь, что вы всегда имеете актуальную версию базы данных в любой момент времени.

[^1]: Database: Migrations, laravel.com [online]. URL: https://laravel.com/docs/migrations.

[^2]: What are database migrations?, prisma.io [online]. URL: https://www.prisma.io/dataguide/types/relational/what-are-database-migrations
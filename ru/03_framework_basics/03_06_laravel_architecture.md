# Архитектура жизненного цикла обработки запроса в Laravel

При использовании любого инструмента необходимо понимать, как он работает. Ведь так вы будете чувствовать себя увереннее и сможете решать возникающие проблемы.
Основой работы Laravel является цикл обработки запроса (request lifecycle). 
В этой статье мы рассмотрим, как происходит обработка запроса в Laravel.

## Цикл обработки запроса

### Первичная обработка запроса

Точкой входа в приложение Laravel является файл `public/index.php`.

Все запросы, поступающие на сервер, направляются на обработку в этот файл.

### HTTP-ядро и ядро консоли

После того, как запрос попадает в файл `public/index.php`, он передается в ядро HTTP или ядро консоли.

Ядро HTTP обрабатывает запросы, поступающие через HTTP, а ядро консоли — запросы, поступающие через консоль.

Основная задача HTTP-ядра — запуск набора так называемых загрузчиков (bootstrappers) перед тем, как обработать запрос. Эти загрузчики настраивают такие вещи, как логирование, обработку ошибок, определение среды приложения (например, тестовая или рабочая), и другие задачи, которые нужно выполнить заранее. Обычно в этих классах происходит работа с настройками Laravel, о которых разработчикам не нужно беспокоиться.

Также HTTP-ядро отвечает за прохождение запроса через "стек посредников" (middleware). Эти посредники занимаются разными задачами, например, работой с сессией, проверкой токенов CSRF, проверкой, не находится ли сайт в режиме обслуживания, и т.д.

### Сервис-провайдеры

> [!NOTE]
> Вы еще не знакомы с сервис-провайдерами, но не волнуйтесь, мы рассмотрим их в следующих статьях.

Одной из самых важных частей работы ядра Laravel является запуск специальных помощников, которые настраивают различные компоненты приложения, например, базу данных, проверку данных, работу с очередями и маршрутизацию.

Laravel проходит по списку таких помощников, создает их и выполняет две основные задачи: сначала настраивает их с помощью метода `register`, а затем запускает с помощью метода `boot`, чтобы все необходимые компоненты были готовы к работе.

Почти все важные функции в Laravel настраиваются через этих помощников, что делает их ключевой частью загрузки приложения. Вы также можете создать свои собственные помощники, если это нужно.

Эти помощники называются **сервис-провайдерами** и они находятся в папке `app/Providers`, мы их рассмотрим в следующих статьях.

### Маршрутизация

Когда приложение загружено, запрос передается специальной системе, которая решает, что с ним делать дальше — отправить на конкретный маршрут или в контроллер для обработки.

> [!TIP]
> Например, при вводе адреса `http://example.com/about`, Laravel должен понять, что нужно показать страницу "О нас". Для этого в Laravel есть маршрутизация.

Перед этим запрос проходит через посредники (middleware). Посредники — это такие проверяющие программы. Например, они могут проверить, вошел ли пользователь в систему. Если нет — посредник перенаправит его на страницу входа. Если всё в порядке, запрос пойдет дальше.

Некоторые посредники проверяют все запросы в приложении, например, когда приложение находится на техобслуживании. Другие работают только на определённых маршрутах. Когда запрос проходит через все нужные посредники, выполняется код, и результат возвращается пользователю через те же посредники.

### Окончание обработки запроса

Когда метод маршрута или контроллера вернет ответ, этот ответ снова пройдет через посредники (middleware). Посредники могут изменить или проверить ответ перед тем, как отправить его пользователю.

После этого метод `handle` HTTP-ядра возвращает этот ответ приложению. Далее вызывается метод `send`, который отправляет ответ в веб-браузер пользователя.

Вот и всё — запрос прошел весь путь через Laravel, и пользователь получил ответ!

![Laravel HTTP Lifecycle](https://imgur.com/LkJvRcb.png) [^2]

[^1]: Request Lifecycle, laravel.com [online]. Available at: https://laravel.com/docs/10.x/lifecycle\
[^2]: Laravel Request Lifecycle, medium [online]. Available at: https://medium.com/@ankitatejani84/laravel-request-lifecycle-7c2145aa1257
# Авторизация

> [!NOTE]
> **Авторизация в веб-приложениях** — это процесс определения прав и привилегий пользователя при доступе к различным ресурсам и функционалу системы. После успешной аутентификации, когда система подтверждает личность пользователя, наступает этап авторизации, определяющий, какие действия пользователь может выполнять. Авторизация отвечает на вопрос: "_Что пользователь может делать?_".

## Типы авторизации в веб-приложениях

Существует несколько моделей авторизации, каждая из которых имеет свои особенности и применяется в зависимости от требований системы:

### 1. Ролевая модель доступа (Role-Based Access Control, RBAC)

В этой модели пользователям назначаются определенные роли, каждая из которых обладает набором разрешений.
**Например**, роли могут включать "_Администратор_", "_Редактор_" и "_Пользователь_", каждая из которых имеет доступ к определенным функциям системы.

**Применение:**

- Корпоративные системы с четко определенными обязанностями сотрудников.
- Веб-приложения с различными уровнями доступа к контенту.

**Преимущества и недостатки:**

| Преимущества                            | Недостатки                                                                                |
| --------------------------------------- | ----------------------------------------------------------------------------------------- |
| Упрощенное управление правами доступа   | Может быть недостаточно гибкой для сложных систем с разнообразными требованиями к доступу |
| Легкость в назначении и изменении ролей |                                                                                           |

### 2. Дискреционная модель доступа (Discretionary Access Control, DAC)

В этой модели владелец ресурса определяет, кто имеет к нему доступ и какие действия разрешены.
Пользователи могут самостоятельно предоставлять или ограничивать доступ к своим ресурсам другим пользователям.

**Применение:**

- Системы обмена файлами.
- Социальные сети, где пользователи контролируют доступ к своему контенту.

**Преимущества и недостатки:**

| Преимущества                                   | Недостатки                                                |
| ---------------------------------------------- | --------------------------------------------------------- |
| Гибкость в управлении доступом                 | Может привести к непреднамеренному предоставлению доступа |
| Пользователи имеют контроль над своими данными | Сложность в управлении правами в больших системах         |

### 3. Мандатная модель доступа (Mandatory Access Control, MAC)

В этой модели доступ к ресурсам определяется центральным администратором на основе установленных политик безопасности.
Пользователи не могут самостоятельно изменять права доступа.

**Применение:**

- Военные и правительственные системы с высокими требованиями безопасности.
- Системы, обрабатывающие конфиденциальные данные.

**Преимущества и недостатки:**

| Преимущества                                    | Недостатки                         |
| ----------------------------------------------- | ---------------------------------- |
| Высокий уровень контроля и безопасности         | Меньшая гибкость для пользователей |
| Минимизация рисков несанкционированного доступа | Сложность в администрировании      |

### 4. Атрибутная модель доступа (Attribute-Based Access Control, ABAC)

ABAC определяет права доступа на основе множества атрибутов, связанных с пользователем, ресурсом, действием и контекстом.
Это позволяет создавать гибкие и сложные политики доступа.

**Применение:**

- Системы с динамическими и сложными требованиями к доступу.
- Облачные сервисы и микросервисы.

**Преимущества и недостатки:**

| Преимущества                                                                  | Недостатки                                                   |
| ----------------------------------------------------------------------------- | ------------------------------------------------------------ |
| Высокая гибкость и гранулярность контроля доступа                             | Сложность в разработке и поддержке политик                   |
| Возможность учитывать контекстные факторы, такие как время или местоположение | Требует тщательного управления атрибутами и их актуальностью |

## Комбинирование моделей авторизации

В реальных приложениях часто используется комбинация различных моделей авторизации для достижения оптимального баланса между безопасностью и удобством. Например, можно сочетать RBAC и ABAC, чтобы сначала определить общие роли, а затем уточнить права доступа с помощью атрибутов.

**Пример:**

- **RBAC:** Назначение пользователю роли "Менеджер".
- **ABAC:** Предоставление менеджеру доступа только к данным его отдела на основе атрибута "Отдел".

Такой подход позволяет создавать более гибкие и масштабируемые системы контроля доступа, учитывающие как общие, так и специфические требования безопасности.

> [!NOTE]
> В контексте Laravel мы рассмотрим две основные модели авторизации: **RBAC** и **ABAC**.
> Laravel предоставляет удобные инструменты для реализации обеих моделей, что позволяет создавать безопасные и гибкие веб-приложения.

## Реализация авторизации в Laravel

В Laravel авторизация основана на использовании **Политик** (Policies) и **Шлюзов** (Gates), которые позволяют определять правила доступа к различным ресурсам и действиям.

- **Политики** определяют правила доступа для конкретной модели (например, пользователь или пост).
- **Шлюзы** позволяют определять правила доступа на уровне действий (например, создание, редактирование или удаление).

### Шлюзы (Gates)

**Шлюзы** — это замыкания, определяющие, может ли пользователь выполнить определенное действие. Они используются для авторизации действий, не связанных с конкретными моделями.

#### Определение шлюзов

Шлюзы обычно определяются в методе `boot` класса `App\Providers\AuthServiceProvider` с использованием `Gate`.

```php
use Illuminate\Support\Facades\Gate;

public function boot()
{
    $this->registerPolicies();
    
    Gate::define('view-dashboard', function ($user) {
        return $user->isAdmin();
    });
}
```

В этом примере определяется шлюз `view-dashboard`, который проверяет, является ли пользователь администратором.

#### Использование шлюзов

После определения шлюза, его можно использовать в представлениях или контроллерах для проверки доступа.

```php
if (Gate::allows('view-dashboard')) {
    // Пользователь может просмотреть панель управления
}

if (Gate::denies('view-dashboard')) {
    // Доступ запрещен
}
```

В шаблонах Blade доступ к шлюзам можно получить с помощью директив `@can` и `@cannot`.

```php
@can('view-dashboard')
    <!-- Показать панель управления -->
@endcan

@cannot('view-dashboard')
    <!-- Контент для обычных пользователей -->
@endcannot
```

### Политики (Policies)

**Политики** — это классы, определяющие правила доступа к определенным моделям. Каждая политика содержит методы для различных действий (например, просмотр, создание, редактирование, удаление).

#### Создание политики**

Для создания политики используйте Artisan-команду:

```bash
php artisan make:policy PostPolicy
```

Эта команда создаст класс политики в директории `app/Policies`.

#### Определение методов политики**

В классе политики определите методы, соответствующие действиям, которые вы хотите авторизовать:

```php
namespace App\Policies;

use App\Models\Post;
use App\Models\User;

class PostPolicy
{
    public function update(User $user, Post $post)
    {
        return $user->id === $post->user_id;
    }
}
```

В этом методе проверяется, является ли пользователь автором поста, прежде чем разрешить обновление.

#### Регистрация политики

После создания политики ее необходимо зарегистрировать в методе `boot` класса `App\Providers\AuthServiceProvider`:

```php
namespace App\Providers;

use App\Models\Post;
use App\Policies\PostPolicy;
use Illuminate\Foundation\Support\Providers\AuthServiceProvider as ServiceProvider;

class AuthServiceProvider extends ServiceProvider
{
    protected $policies = [
        Post::class => PostPolicy::class,
    ];

    public function boot()
    {
        $this->registerPolicies();
    }
}
```

Теперь Laravel будет использовать эту политику для авторизации действий с моделью `Post`.

#### Использование политики

После регистрации политики вы можете использовать ее в контроллерах или представлениях для проверки доступа:

```php
if ($request->user()->can('update', $post)) {
    // Пользователь может обновить пост
}
```

В представлениях Blade доступ к политикам можно получить с помощью директив `@can` и `@cannot`.

```php
@can('update', $post)
    <!-- Показать кнопку редактирования -->
@endcan

@cannot('update', $post)
    <!-- Скрыть кнопку редактирования -->
@endcannot
```

#### Ответы политик

Политики могут возвращать различные значения для разрешения или отклонения доступа:

- `true` — доступ разрешен.
- `false` — доступ запрещен.
- `null` — политика не определена для данного действия.
- `Response` — специальный объект ответа, позволяющий указать причину отказа в доступе.

`Response` может быть создан с помощью методов `allow`, `deny` и `message`:

```php
use Illuminate\Auth\Access\Response;

public function update(User $user, Post $post)
{
    if ($user->id === $post->user_id) {
        return Response::allow();
    } else {
        return Response::deny('Вы не являетесь автором этого поста.');
    }
}
```

Это позволяет предоставить пользователю информацию о причине отказа в доступе.

## Заключение

Авторизация — важный аспект безопасности веб-приложений, который позволяет контролировать доступ пользователей к различным ресурсам и функциям системы. В Laravel авторизация реализуется с помощью **Политик** и **Шлюзов**, которые позволяют определять правила доступа на уровне моделей и действий. Понимание различных моделей авторизации и их применение в Laravel поможет создать безопасные и гибкие веб-приложения.